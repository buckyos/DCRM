# 基于后付费的服务证明的通用设计

## Step1 买卖双方创建一个可公开的，双方签名的契约。
这是一个买卖双方签名并保存在各自的磁盘上的数字合同，创建后`并不需要保存在链上`。这个数字合同的内容是“买家B 以xxx价格购买了一段时间内卖家S向C提供的服务X（X的详细内容，一般是技术指标）”。    
注意这里有三方，会存在B购买服务给C使用的情况，但很多时候，B和C是同一个用户。       
这个契约不保存着链上的风险在于后付费的情况下，B可能在服务结束后没有足够的余额进行支付。要不要上链取决于S对B的信用判断，如果上联的话，可能S还会需要B在契约内打入`保证金`.上链手续费由B、S协商。      
存储类服务还要求S提供`保证金`，因为S一旦`中途违约`，丢失了保存的数据，那么可能会给B带来很大的损失。    
建立契约的过程和建立闪电网络的支付通道类似，在有保证金的情况下，实际上创造的是一个`共享账户`。这个共享账户在确认一方违约的情况下，可以把账户余额全数转给另一方。    
 
## Step2 契约建立后，S就要开始给C提供服务了。
在提供服务的过程中，S会通过P2P Tunnel不断的问C索要`C签名`的`已服务证明`，这个服务证明是不需要上链的。索要的过程也可以是C定期提供。
如果C不愿意提供“已服务证明”，那么S可以立刻中断服务。 如果C觉得S的服务质量很差，也可以不提供“已服务证明”。
如果C和B是同一个人，B也可以通过直接付一个阶段性费用的方法来表达自己对服务满意。

这里的主要问题是C有没有在成本范围内对S提供的服务的正确性进行验证？
 
## Step3 付款
如果B对S的服务没有意见，那么在契约时间到达的时候可以按契约约定的（价格*用量）给S付款。否则不付款。
如果S确实提供了高质量的服务，但B迟迟不付款，S可以把`契约`和所有收到的`C签名的已服务证明`提交到链上进行仲裁。设计良好的服务证明机制可以显然的证明S的服务是高质量的，仲裁机构会扣除B的保证金，或降低B的信用，来保障S的利益。

## 请假机制
在契约约定的时间内，S/B/C 因为其它愿意不能主动履约的，可以提出暂时请假。请假条多签名后生效。

## 思考
### 优点
服务证明的设计的优点是“链下操作”，在买卖双方互信的情况下，进行交易只有支付操作上链，对链的负载低。
服务证明的设计并不要求100%的可靠，C愿不愿出示服务证明可以有自己的独立算法，并不要求做100%可靠的检测。
另一个优势是提供了一定的“协商空间”，如果B、C、S对服务的质量问题能通过其他渠道达成一致，也不用设计链上机制处理

### 缺点
服务证明很多时候是基于统计的，不是100%可靠的，这里可能会系统带来整体性的风险。
存在C和S一起串通，坑B的可能性。这需要B慎重的选择C。这需要B设计合理的机制来慎重的选择C，或则给每个C一个积分上限，防止单个C消耗太多的资源。

